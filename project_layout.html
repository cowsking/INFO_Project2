<head>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>

<style>
  .state {
    fill: lightgrey;
  }

  .outline {
    stroke: black;
    stroke-width: 1px;
    fill: none;
  }
</style>

<body>
  <div class="container">
    <h2>Find some features ..</h2>
    <a href="#" class="btn-gradient cyan mini" id="gen">#Gender#</a>
    <a href="#" class="btn-gradient orange mini" id="rac">#Race#</a>
    <a href="#" class="btn-gradient blue mini" id="par">#Party#</a>
  </div>



  <br>Filter<br>
<div class="income">
  Median Household Income
  <select id="incomeAbove">
    <option value="true">Above</option>
    <option value="">Below</option>
  </select>
  <input type="range" min="1" max="150000" value="0" class="slider" id="incomeSlider">
  <g id="incomeDisplay">$0</g>
</div>
  <br>
  Percent with a Bachelor's or Higher
  <select name="cars" id="cars">
    <option value="volvo">Above</option>
    <option value="saab">Below</option>
  </select>
  <form style="display: inline"><input type="number" value="0" /></form>
  <br />

  Percent of Population of a certain race/ethnicity
  <select name="cars" id="cars">
    <option value="volvo">Asian</option>
    <option value="saab">Black</option>
    <option value="saab">Hispanic</option>
    <option value="saab">White</option>
  </select>

  <select name="cars" id="cars">
    <option value="volvo">Above</option>
    <option value="saab">Below</option>
  </select>
  <form style="display: inline"><input type="number" value="0" /></form>
  <br />
  <!-- <svg height="700" width="1400" style="border: 1px solid black"></svg> -->
  <div id="main" height="700" width="1400"></div>
</body>
<script>
  const main = d3.select("div#main");

  const svg = main
    .append("svg")
    .attr("width", 1100)
    .attr("height", 580)
    .style("margin", 20);
  // svg.append("text").attr("x", 350).attr("y", 260).text("USA Map goes here");

  const width = svg.attr("width");
  const height = svg.attr("height");
  margin = 20;
  const mapWidth = width - margin - margin;
  const mapHeight = height - margin - margin;
  const map = svg
    .append("g")
    .attr("transform", "translate(" + 20 + "," + 20 + ")");

  // const name = document.querySelector("container");
  // const btn = document.querySelector("button");
  // btn.addEventListener("click", changemap());

  const requestData = async function () {
    const us_house = await d3.json("./us-house.topojson");
    // const us_house = await d3.json("./us-house.geojson");
    console.log(us_house);
    var zips = topojson.feature(us_house, us_house.objects["us-house-us-house"]);
    var zipsMesh = topojson.mesh(us_house, us_house.objects["us-house-us-house"]);


//Load District Demographics Data

//statelist without alaska or hawaii until it gets put back
const stateList = ['Alabama','Arizona','Arkansas','California','Colorado','Connecticut','Delaware','Florida','Georgia','Idaho','Illinois','Indiana','Iowa','Kansas','Kentucky','Louisiana','Maine','Maryland','Massachusetts','Michigan','Minnesota','Mississippi','Missouri','Montana','Nebraska','Nevada','New_Hampshire','New_Jersey','New_Mexico','New_York','North_Carolina','North_Dakota','Ohio','Oklahoma','Oregon','Pennsylvania','Rhode_Island','South_Carolina','South_Dakota','Tennessee','Texas','Utah','Vermont','Virginia','Washington','West_Virginia','Wisconsin','Wyoming'];

let districtData = [];
for (let i = 0; i < stateList.length; i++) {
  districtData.push(d3.csv("DistrictDemoData\\"+stateList[i]+"_District_all.csv")); 
}
districtData = await Promise.all(districtData);
for (let i = 0; i < stateList.length; i++) {
  districtData[i].state = stateList[i];   
}

console.log(districtData);
    console.log(zips);
    // console.log(us_house);
    // var center = d3.geo.centroid(us_house)
    // var scale = 1000;
    var projection = d3
      .geoAlbersUsa()
      .fitSize([mapWidth, mapHeight], zips);
    // .scale(scale)
    // .translate([mapWidth / 2 + 1670, mapHeight / 2 + 700]);
    // var path = d3.geoPath().projection(projection);
    var path = d3.geoPath().projection(projection);

    // zips.features.forEach(d => {
    //   console.log(d.properties.ethnicity);
    // });

    function genderColor(gender) {
      if (gender == "male") {
        return "#75CDEF";
      }
      if (gender == "female") {
        return "#FF6B6B";
      }
    }

    function partyColor(party) {
      if (party == "democrat") {
        return "#75CDEF";
      }
      if (party == "republican") {
        return "#FF6B6B";
      }
    }

    function raceColor(race) {
      if (race == "white-american") {
        return "#75CDEF";
      }
      if (race == "african-american") {
        return "#BC514C";
      }
      if (race == "hispanic-american") {
        return "#F15E61";
      }
      if (race == "asian-american") {
        return "#F1A55E";
      }
      if (race == "multi-racial-american") {
        return "#A55EF1";
      }
      if (race == "native-american") {
        return "#5EF1A5";
      }
    }
    
    map.append("path").datum(zipsMesh)
        .attr("class", "outline")
        .attr("d", path)
        .attr("stroke", "white")
        .attr("stroke-width", 2);

let activeColor = null;

    let btnGen = document.getElementById("gen");
    btnGen.onclick = function () {
      map.selectAll("path.state").data(zips.features)
        .join("path")
        .attr("class", "state")
        .attr("d", path)
        .style("fill", d => genderColor(d.properties.gender));

      map.append("path").datum(zipsMesh)
        .attr("class", "outline")
        .attr("d", path)
        .attr("stroke", "white")
        .attr("stroke-width", 2);
activeColor = function(d) {
return genderColor(d.properties.gender)
};
    };

    let btnPar = document.getElementById("par");
    btnPar.onclick = function () {
      map.selectAll("path.state").data(zips.features)
        .join("path")
        .attr("class", "state")
        .attr("d", path)
        .style("fill", d => partyColor(d.properties.party));

      map.append("path").datum(zipsMesh)
        .attr("class", "outline")
        .attr("d", path)
        .attr("stroke", "white")
        .attr("stroke-width", 2);

activeColor = function(d) {
return partyColor(d.properties.party)
};
    };

    let btnRac = document.getElementById("rac");
    btnRac.onclick = function () {
      map.selectAll("path.state").data(zips.features)
        .join("path")
        .attr("class", "state")
        .attr("d", path)
        .style("fill", d => raceColor(d.properties.ethnicity));

      map.append("path").datum(zipsMesh)
        .attr("class", "outline")
        .attr("d", path)
        .attr("stroke", "white")
        .attr("stroke-width", 2);
activeColor = function(d) {
return raceColor(d.properties.ethnicity);
};
    };

//statelist without alaska or hawaii until it gets put back
const stateList2 = ['Alabama','Arizona','Arkansas','California','Colorado','Connecticut','Delaware','Florida','Georgia','Idaho','Illinois','Indiana','Iowa','Kansas','Kentucky','Louisiana','Maine','Maryland','Massachusetts','Michigan','Minnesota','Mississippi','Missouri','Montana','Nebraska','Nevada','New Hampshire','New Jersey','New Mexico','New York','North Carolina','North Dakota','Ohio','Oklahoma','Oregon','Pennsylvania','Rhode Island','South Carolina','South Dakota','Tennessee','Texas','Utah','Vermont','Virginia','Washington','West Virginia','Wisconsin','Wyoming'];

const typeDictionary = {"income": 198};

//returns true if district passes filter (show color) and false if district fails filter (make it gray)
filterColor = function (state_name, district, above, type, quantity) {
let stateIndex = stateList2.indexOf(state_name);
let typeIndex = typeDictionary[type];
let districtIndex = "District 01 Estimate";
if(district != null){
districtIndex = Number(district)<=9 ? "District 0"+district+" Estimate": "District "+district+" Estimate";
};
let temp = Number(districtData[stateIndex][typeIndex][districtIndex]);
console.log(state_name+"  temp= "+temp +"  quantity=  "+quantity+" is temp > quanitity?  "+Boolean((temp>quantity))+" above is  "+Boolean(above)+"  does above == (temp>quantity)?  " + (Boolean(above) == Boolean(temp>quantity)) );

return (Boolean(above) == Boolean(temp>quantity));

}
updateMap = function(aboveOrBelow, type, quantity) {
map.selectAll("path.state").data(zips.features)
        .join("path")
        .style("fill", d => filterColor(d.properties.state_name, d.properties.district, aboveOrBelow, type, quantity) ? activeColor(d) : "grey");
}
const incomeAbove = document.getElementById("incomeAbove");
const incomeSlider = document.getElementById("incomeSlider");
const incomeInput = document.getElementById("incomeInput");
incomeSlider.onchange = function(){updateMap(incomeAbove.value, "income", incomeSlider.value)};
incomeSlider.oninput = function(){document.getElementById("incomeDisplay").innerHTML = "$"+incomeSlider.value};
incomeAbove.onchange = function(){updateMap(incomeAbove.value, "income", incomeSlider.value)};


console.log(incomeSlider);
  };
  requestData();

  // svg
  //   .append("circle")
  //   .attr("cx", 1200)
  //   .attr("cy", 350)
  //   .attr("r", 150)
  //   .style("fill", "lightblue");
  // svg.append("text").attr("x", 1100).attr("y", 350).text("pie chart goes here");
</script>