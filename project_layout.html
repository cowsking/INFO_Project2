<head>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>

<style>
  .state {
    fill: lightgrey;
  }

  .outline {
    stroke: black;
    stroke-width: 1px;
    fill: none;
  }
</style>

<body>
  <div class="container">
    <h2>Find some features ..</h2>
    <a href="#" class="btn-gradient cyan mini" id="gen">#Gender#</a>
    <a href="#" class="btn-gradient orange mini" id="rac">#Race#</a>
    <a href="#" class="btn-gradient blue mini" id="par">#Party#</a>
  </div>

  <select id="outcomeSelect">
    <option value="party" selected>Party</option>
    <option value="gender">Gender</option>
    <option value="race">Race</option>
  </select>

  <br>Filter<br>
<div class="income">
  Median Household Income
  <select id="incomeAbove">
    <option value="true">Above</option>
    <option value="">Below</option>
  </select>
  <input type="range" min="0" max="150000" value="0" class="slider" id="incomeSlider">
  <g id="incomeDisplay">$0</g>
</div>
  <br>
  Percent with a Bachelor's or Higher
  <select name="cars" id="bachelorsAbove">
    <option value="true">Above</option>
    <option value="">Below</option>
  </select>
  <input type="range" min="0" max="100" value="0" class="slider" id="bachelorsSlider">
<g id="bachelorsDisplay">0%</g>
  <br />

  Percent of Population of a certain race/ethnicity
  <select name="cars" id="raceSelection">
    <option value="asian">Asian</option>
    <option value="black">Black</option>
    <option value="hispanic">Hispanic</option>
    <option value="white">White</option>
  </select>

  <select name="cars" id="raceAbove">
    <option value="volvo">Above</option>
    <option value="saab">Below</option>
  </select>
  <input type="range" min="0" max="100" value="0" class="slider" id="raceSlider">
<g id="raceDisplay">0%</g>
  <br />
  <!-- <svg height="700" width="1400" style="border: 1px solid black"></svg> -->
  <div id="main" height="700" width="1400"></div>
</body>
<script>
  const main = d3.select("div#main");

  const svg = main
    .append("svg")
    .attr("width", 1100)
    .attr("height", 580)
    .style("margin", 20);

  const width = svg.attr("width");
  const height = svg.attr("height");
  margin = 20;
  const mapWidth = width - margin - margin;
  const mapHeight = height - margin - margin;
  const map = svg
    .append("g")
    .attr("transform", "translate(" + 20 + "," + 20 + ")");

  // const name = document.querySelector("container");
  // const btn = document.querySelector("button");
  // btn.addEventListener("click", changemap());

  const requestData = async function () {
    const us_house = await d3.json("./us-house.topojson");
    // const us_house = await d3.json("./us-house.geojson");
    console.log(us_house);
    var zips = topojson.feature(us_house, us_house.objects["us-house-us-house"]);
    var zipsMesh = topojson.mesh(us_house, us_house.objects["us-house-us-house"]);


//Load District Demographics Data
const stateList = ['Alabama','Alaska','Arizona','Arkansas','California','Colorado','Connecticut','Delaware','Florida','Georgia','Hawaii','Idaho','Illinois','Indiana','Iowa','Kansas','Kentucky','Louisiana','Maine','Maryland','Massachusetts','Michigan','Minnesota','Mississippi','Missouri','Montana','Nebraska','Nevada','New_Hampshire','New_Jersey','New_Mexico','New_York','North_Carolina','North_Dakota','Ohio','Oklahoma','Oregon','Pennsylvania','Rhode_Island','South_Carolina','South_Dakota','Tennessee','Texas','Utah','Vermont','Virginia','Washington','West_Virginia','Wisconsin','Wyoming'];

let districtData = [];
for (let i = 0; i < stateList.length; i++) {
  districtData.push(d3.csv("DistrictDemoData\\"+stateList[i]+"_District_all.csv")); 
}
districtData = await Promise.all(districtData);
for (let i = 0; i < stateList.length; i++) {
  districtData[i].state = stateList[i];   
}
console.log(districtData);
    console.log(zips);
    // console.log(us_house);
    // var center = d3.geo.centroid(us_house)
    // var scale = 1000;
    var projection = d3
      .geoAlbersUsa()
      .fitSize([mapWidth, mapHeight], zips);
    // .scale(scale)
    // .translate([mapWidth / 2 + 1670, mapHeight / 2 + 700]);
    // var path = d3.geoPath().projection(projection);
    var path = d3.geoPath().projection(projection);

    // zips.features.forEach(d => {
    //   console.log(d.properties.ethnicity);
    // });

    function genderColor(gender) {
      if (gender == "male") {
        return "#75CDEF";
      }
      if (gender == "female") {
        return "#FF6B6B";
      }
    }

    function partyColor(party) {
      if (party == "democrat") {
        return "#75CDEF";
      }
      if (party == "republican") {
        return "#FF6B6B";
      }
    }

    function raceColor(race) {
      if (race == "white-american") {
        return "#75CDEF";
      }
      if (race == "african-american") {
        return "#BC514C";
      }
      if (race == "hispanic-american") {
        return "#F15E61";
      }
      if (race == "asian-american") {
        return "#F1A55E";
      }
      if (race == "multi-racial-american") {
        return "#A55EF1";
      }
      if (race == "native-american") {
        return "#5EF1A5";
      }
    }
    
    map.append("path").datum(zipsMesh)
        .attr("class", "outline")
        .attr("d", path)
        .attr("stroke", "white")
        .attr("stroke-width", 2);

let activeColor = null;
//initialize map
map.selectAll("path.state").data(zips.features)
        .join("path")
        .attr("class", "state")
        .attr("d", path)
        .style("fill", d => partyColor(d.properties.party));

map.append("path").datum(zipsMesh)
        .attr("class", "outline")
        .attr("d", path)
        .attr("stroke", "white")
        .attr("stroke-width", 2);

    let btnGen = document.getElementById("gen");
    btnGen.onclick = function () {
      map.selectAll("path.state").data(zips.features)
        .join("path")
        .attr("class", "state")
        .attr("d", path)
        .style("fill", d => genderColor(d.properties.gender));

      map.append("path").datum(zipsMesh)
        .attr("class", "outline")
        .attr("d", path)
        .attr("stroke", "white")
        .attr("stroke-width", 2);
activeColor = function(d) {
return genderColor(d.properties.gender)
};
    };

    let btnPar = document.getElementById("par");
    btnPar.onclick = function () {
      map.selectAll("path.state").data(zips.features)
        .join("path")
        .attr("class", "state")
        .attr("d", path)
        .style("fill", d => partyColor(d.properties.party));

      map.append("path").datum(zipsMesh)
        .attr("class", "outline")
        .attr("d", path)
        .attr("stroke", "white")
        .attr("stroke-width", 2);

activeColor = function(d) {
return partyColor(d.properties.party)
};
    };

    let btnRac = document.getElementById("rac");
    btnRac.onclick = function () {
      map.selectAll("path.state").data(zips.features)
        .join("path")
        .attr("class", "state")
        .attr("d", path)
        .style("fill", d => raceColor(d.properties.ethnicity));

      map.append("path").datum(zipsMesh)
        .attr("class", "outline")
        .attr("d", path)
        .attr("stroke", "white")
        .attr("stroke-width", 2);
activeColor = function(d) {
return raceColor(d.properties.ethnicity);
};
    };

const stateList2 = ['Alabama','Alaska','Arizona','Arkansas','California','Colorado','Connecticut','Delaware','Florida','Georgia','Hawaii','Idaho','Illinois','Indiana','Iowa','Kansas','Kentucky','Louisiana','Maine','Maryland','Massachusetts','Michigan','Minnesota','Mississippi','Missouri','Montana','Nebraska','Nevada','New Hampshire','New Jersey','New Mexico','New York','North Carolina','North Dakota','Ohio','Oklahoma','Oregon','Pennsylvania','Rhode Island','South Carolina','South Dakota','Tennessee','Texas','Utah','Vermont','Virginia','Washington','West Virginia','Wisconsin','Wyoming'];

const typeDictionary = {"income": 198, "bachelors":240, "totalPop": 19, "white": 21, "blackn": 22, "asian": 24, "hispanic": 28};

//returns true if district passes filter (show color) and false if district fails filter (make it gray)
filter = function (state_name, district) {
let stateIndex = stateList2.indexOf(state_name);
let bachelorsIndex = 240;
let totalPopIndex = 19;
let raceIndex = typeDictionary[document.getElementById("raceSelection").value];
let districtIndex = "District 01 Estimate";
if(district != null){
districtIndex = Number(district)<=9 ? "District 0"+district+" Estimate": "District "+district+" Estimate"; };

let incomeCompare = Number(districtData[stateIndex][198][districtIndex]) > Number(document.getElementById("incomeSlider").value);
let bachelorsCompare = Number(districtData[stateIndex][240][districtIndex]) > Number(document.getElementById("bachelorsSlider").value);
let raceCompare = (100 * Number(districtData[stateIndex][raceIndex][districtIndex]) / Number(districtData[stateIndex][19][districtIndex]) ) > Number(document.getElementById("raceSlider").value);
let incomeFilter = (Boolean(incomeCompare) == Boolean(document.getElementById("incomeAbove").value));
let bachelorsFilter = (Boolean(bachelorsCompare) == Boolean(document.getElementById("bachelorsAbove").value));
let raceFilter = (Boolean(raceCompare) == Boolean(document.getElementById("raceAbove").value));
return (incomeFilter && bachelorsFilter && raceFilter);

}
outcomeFunctions = {"party": function(d) {return partyColor(d.properties.party)}, "gender": function(d) {return genderColor(d.properties.gender)}, "race": function(d) {return raceColor(d.properties.ethnicity)} };
updateMap = function() {
map.selectAll("path.state").data(zips.features)
        .join("path")
        .style("fill", d => filter(d.properties.state_name, d.properties.district) ? outcomeFunctions[document.getElementById("outcomeSelect").value](d) : "grey");
}
//filter color returns true of false whether the district meets filter based on all 3 slider values
//active color returns correct function to color based on selected outcome
//hawaii not showing up??
const incomeAbove = document.getElementById("incomeAbove");
const incomeSlider = document.getElementById("incomeSlider");
const incomeInput = document.getElementById("incomeInput");
//incomeSlider.onchange = function(){updateMap(incomeAbove.value, "income", incomeSlider.value)};
incomeSlider.oninput = function(){document.getElementById("incomeDisplay").innerHTML = "$"+incomeSlider.value};
//incomeAbove.onchange = function(){updateMap(incomeAbove.value, "income", incomeSlider.value)};

document.getElementById("incomeAbove").onchange = function(){updateMap()};
document.getElementById("incomeSlider").onchange = function(){updateMap()};
document.getElementById("incomeSlider").oninput = function(){document.getElementById("incomeDisplay").innerHTML = "$"+incomeSlider.value};

document.getElementById("bachelorsAbove").onchange = function(){updateMap()};
document.getElementById("bachelorsSlider").onchange = function(){updateMap()};
document.getElementById("bachelorsSlider").oninput = function(){document.getElementById("bachelorsDisplay").innerHTML = bachelorsSlider.value+"%"};

document.getElementById("raceAbove").onchange = function(){updateMap()};
document.getElementById("raceSlider").onchange = function(){updateMap()};
document.getElementById("raceSlider").oninput = function(){document.getElementById("raceDisplay").innerHTML = raceSlider.value+"%"};

document.getElementById("outcomeSelect").onchange = function(){updateMap()};
  };
  requestData();

  // svg
  //   .append("circle")
  //   .attr("cx", 1200)
  //   .attr("cy", 350)
  //   .attr("r", 150)
  //   .style("fill", "lightblue");
  // svg.append("text").attr("x", 1100).attr("y", 350).text("pie chart goes here");
</script>